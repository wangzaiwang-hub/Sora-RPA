#!/usr/bin/env python3
# -*- coding: utf-8 -*-

"""
Sora è‡ªåŠ¨åŒ–æ ¸å¿ƒæ¨¡å?
ä½¿ç”¨ ixBrowser å®˜æ–¹ API + Selenium
"""

import time
from ixbrowser_local_api import IXBrowserClient
from selenium.webdriver import Chrome
from selenium.webdriver.chrome.options import Options
from selenium.webdriver.chrome.service import Service
from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC

class SoraAutomation:
    def __init__(self, profile_id=None):
        """
        åˆå§‹åŒ?Sora è‡ªåŠ¨åŒ–å·¥å…?
        
        Args:
            profile_id: ixBrowser çª—å£ IDï¼Œå¦‚æœä¸º None åˆ™ä½¿ç”¨ç¬¬ä¸€ä¸ªçª—å?
        """
        self.client = IXBrowserClient()
        self.profile_id = profile_id
        self.driver = None
        self.debugging_address = None
        self.is_mobile = None  # æ˜¯å¦ä¸ºæ‰‹æœºUA
        
    def _get_profile_id(self):
        """è·å–çª—å£ ID - ä¼˜å…ˆä½¿ç”¨çª—å£ 23"""
        if self.profile_id:
            return self.profile_id
        
        # ç›´æ¥å°è¯•ä½¿ç”¨çª—å£ 23
        print('  å°è¯•ä½¿ç”¨çª—å£ 23...')
        
        # éªŒè¯çª—å£ 23 æ˜¯å¦å­˜åœ¨
        all_profiles = self.client.get_profile_list(limit=100)
        if all_profiles:
            for profile in all_profiles:
                if profile['profile_id'] == 23:
                    print(f'  âœ?æ‰¾åˆ°çª—å£ 23: {profile.get("name")}')
                    return 23
        
        # å¦‚æœæ²¡æ‰¾åˆ°ï¼Œç›´æ¥è¿”å› 23ï¼ˆè®©åç»­æµç¨‹å°è¯•æ‰“å¼€ï¼?
        print('  âš ï¸  çª—å£ 23 ä¸åœ¨åˆ—è¡¨ä¸­ï¼Œä½†ä»å°è¯•ä½¿ç”¨')
        return 23
    
    def _open_browser(self):
        """æ‰“å¼€æµè§ˆå™¨çª—å?""
        profile_id = self._get_profile_id()
        
        print(f'  è¿æ¥åˆ?ixBrowser çª—å£: {profile_id}')
        
        # å°è¯•æ‰“å¼€çª—å£ï¼ˆå¦‚æœå·²æ‰“å¼€ä¼šè¿”å›é”™è¯¯ï¼Œä½†æˆ‘ä»¬ä¼šå¤„ç†ï¼?
        open_result = self.client.open_profile(
            profile_id,
            cookies_backup=False,
            load_profile_info_page=False
        )
        
        # å¦‚æœçª—å£å·²ç»æ‰“å¼€
        if open_result is None and self.client.message:
            error_msg = str(self.client.message).lower()
            if 'already open' in error_msg or 'å·²ç»æ‰“å¼€' in error_msg or 'å·²æ‰“å¼€' in error_msg:
                print('  âœ?çª—å£å·²æ‰“å¼€ï¼Œè·å–è¿æ¥ä¿¡æ?..')
                
                # å†æ¬¡å°è¯•è°ƒç”¨ APIï¼Œæœ‰æ—¶ä¼šè¿”å›è¿æ¥ä¿¡æ¯
                time.sleep(0.5)
                open_result = self.client.open_profile(
                    profile_id,
                    cookies_backup=False,
                    load_profile_info_page=False
                )
                
                # å¦‚æœè¿˜æ˜¯å¤±è´¥ï¼Œè¯´æ˜æ— æ³•è·å–è¿æ¥ä¿¡æ¯ï¼Œéœ€è¦é‡å¯çª—å?
                if open_result is None:
                    print('  âš ï¸  æ— æ³•è·å–è¿æ¥ä¿¡æ¯ï¼Œå°è¯•é‡å¯çª—å?)
                    print('  å…³é—­çª—å£...')
                    
                    close_result = self.client.close_profile(profile_id)
                    if close_result:
                        print('  âœ?çª—å£å·²å…³é—?)
                        time.sleep(3)
                    else:
                        print(f'  âš ï¸  å…³é—­å¤±è´¥: {self.client.message}')
                        print('  âš ï¸  çª—å£å¯èƒ½ä¸æ˜¯é€šè¿‡ API æ‰“å¼€çš„ï¼Œæ— æ³•æ§åˆ¶')
                        print('  æç¤º: è¯·æ‰‹åŠ¨å…³é—­çª—å£ï¼Œæˆ–ä½¿ç”¨å…¶ä»–çª—å?)
                        raise Exception(f'æ— æ³•æ§åˆ¶å·²æ‰“å¼€çš„çª—å?{profile_id}ï¼Œè¯·æ‰‹åŠ¨å…³é—­æˆ–é€‰æ‹©å…¶ä»–çª—å£')
                    
                    print('  é‡æ–°æ‰“å¼€çª—å£...')
                    open_result = self.client.open_profile(
                        profile_id,
                        cookies_backup=False,
                        load_profile_info_page=False
                    )
                    
                    if open_result is None:
                        raise Exception(f'æ‰“å¼€çª—å£å¤±è´¥: {self.client.message}')
                    
                    print('  âœ?çª—å£å·²é‡æ–°æ‰“å¼€')
            else:
                # å…¶ä»–é”™è¯¯
                raise Exception(f'æ‰“å¼€çª—å£å¤±è´¥: {self.client.message}')
        
        else:
            # çª—å£æˆåŠŸæ‰“å¼€
            print('  âœ?çª—å£å·²æ‰“å¼€')
        
        # è·å–è¿æ¥ä¿¡æ¯
        web_driver_path = open_result['webdriver']
        self.debugging_address = open_result['debugging_address']
        
        print(f'  è°ƒè¯•åœ°å€: {self.debugging_address}')
        
        # è¿æ¥åˆ°æµè§ˆå™¨
        chrome_options = Options()
        chrome_options.add_experimental_option("debuggerAddress", self.debugging_address)
        
        self.driver = Chrome(
            service=Service(web_driver_path),
            options=chrome_options
        )
        
        print('  âœ?Selenium å·²è¿æ?)
        
        # æ£€æµ‹UAç±»å‹
        self._detect_ua_type()
    
    def _detect_ua_type(self):
        """æ£€æµ‹UAç±»å‹ï¼ˆç”µè„‘æˆ–æ‰‹æœºï¼?""
        try:
            user_agent = self.driver.execute_script("return navigator.userAgent;")
            print(f'  User Agent: {user_agent}')
            
            # æ£€æµ‹æ˜¯å¦ä¸ºç§»åŠ¨è®¾å¤‡UA
            mobile_keywords = ['Mobile', 'Android', 'iPhone', 'iPad', 'iPod', 'Windows Phone']
            self.is_mobile = any(keyword in user_agent for keyword in mobile_keywords)
            
            print(f'  UAç±»å‹: {"æ‰‹æœº" if self.is_mobile else "ç”µè„‘"}')
        except Exception as e:
            print(f'  æ£€æµ‹UAå¤±è´¥: {e}ï¼Œé»˜è®¤ä½¿ç”¨ç”µè„‘æ¨¡å¼?)
            self.is_mobile = False
    
    def _check_login_status(self):
        """æ£€æµ‹çª—å£æ˜¯å¦å·²ç™»å½•"""
        try:
            print('  æ£€æµ‹ç™»å½•çŠ¶æ€?..')
            
            # ç­‰å¾…é¡µé¢åŠ è½½
            time.sleep(2)
            
            current_url = self.driver.current_url
            print(f'  å½“å‰é¡µé¢: {current_url}')
            
            # æ£€æŸ¥æ˜¯å¦åœ¨ Sora é¡µé¢
            if 'sora.chatgpt.com' in current_url.lower():
                print('  âœ?å·²åœ¨ Sora é¡µé¢ï¼Œè´¦å·å·²ç™»å½•')
                return True
            
            # æ£€æŸ¥æ˜¯å¦åœ¨ç™»å½•é¡µé¢
            if 'auth' in current_url.lower() or 'login' in current_url.lower():
                print('  âš ï¸  åœ¨ç™»å½•é¡µé¢ï¼Œéœ€è¦ç™»å½?)
                return False
            
            # å°è¯•è®¿é—® Sora é¡µé¢æ¥éªŒè¯ç™»å½•çŠ¶æ€?
            print('  å°è¯•è®¿é—® Sora é¡µé¢éªŒè¯ç™»å½•çŠ¶æ€?..')
            self.driver.get('https://sora.chatgpt.com/explore')
            time.sleep(3)
            
            current_url = self.driver.current_url
            if 'sora.chatgpt.com' in current_url.lower():
                print('  âœ?æˆåŠŸè®¿é—® Sora é¡µé¢ï¼Œè´¦å·å·²ç™»å½•')
                return True
            else:
                print('  âš ï¸  æ— æ³•è®¿é—® Sora é¡µé¢ï¼Œéœ€è¦ç™»å½?)
                return False
                
        except Exception as e:
            print(f'  æ£€æµ‹ç™»å½•çŠ¶æ€å¤±è´? {e}')
            return False
    
    def _login_account(self, username: str, password: str):
        """ç™»å½•è´¦å·"""
        try:
            print(f'  å¼€å§‹ç™»å½•è´¦å? {username}')
            
            # å¯¼èˆªåˆ°ç™»å½•é¡µé?
            self.driver.get('https://chatgpt.com/auth/login')
            time.sleep(3)
            
            # è¿™é‡Œéœ€è¦æ ¹æ®å®é™…çš„ç™»å½•é¡µé¢ç»“æ„æ¥å®ç°ç™»å½•é€»è¾‘
            # ç”±äº ChatGPT çš„ç™»å½•æµç¨‹æ¯”è¾ƒå¤æ‚ï¼Œå»ºè®®æ‰‹åŠ¨ç™»å½•ä¸€æ¬?
            # æˆ–è€…ä½¿ç”?cookies æ¥ä¿æŒç™»å½•çŠ¶æ€?
            
            print('  âš ï¸  è¯·æ‰‹åŠ¨å®Œæˆç™»å½•æµç¨?)
            print('  æç¤º: å»ºè®®åœ?ixBrowser ä¸­é¢„å…ˆç™»å½•è´¦å·ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨æ£€æµ‹ç™»å½•çŠ¶æ€?)
            
            # ç­‰å¾…ç”¨æˆ·æ‰‹åŠ¨ç™»å½•ï¼ˆå¯é€‰ï¼‰
            # input('  ç™»å½•å®ŒæˆåæŒ‰å›è½¦ç»§ç»­...')
            
            return True
            
        except Exception as e:
            print(f'  ç™»å½•å¤±è´¥: {e}')
            return False
    
    def _navigate_to_sora(self):
        """å¯¼èˆªåˆ?Sora é¡µé¢"""
        sora_url = 'https://sora.chatgpt.com/explore'
        
        try:
            # ç­‰å¾…é¡µé¢åŠ è½½å®Œæˆ
            time.sleep(1)
            
            current_url = self.driver.current_url
            print(f'  å½“å‰é¡µé¢: {current_url}')
            
            # æ£€æŸ¥æ˜¯å¦å·²ç»åœ¨ Sora é¡µé¢
            if 'sora.chatgpt.com' in current_url.lower():
                print('  âœ?å·²åœ¨ Sora é¡µé¢ï¼Œè·³è¿‡å¯¼èˆ?)
                return
            
            # éœ€è¦å¯¼èˆªåˆ° Sora
            print(f'  å¯¼èˆªåˆ?Sora: {sora_url}')
            
            # è®¾ç½®é¡µé¢åŠ è½½è¶…æ—¶
            self.driver.set_page_load_timeout(30)
            
            try:
                self.driver.get(sora_url)
            except Exception as nav_error:
                print(f'  âš ï¸  å¯¼èˆªè¶…æ—¶æˆ–å¤±è´? {nav_error}')
                # å°è¯•åœæ­¢åŠ è½½
                try:
                    self.driver.execute_script("window.stop();")
                except:
                    pass
            
            # ç­‰å¾…é¡µé¢åŠ è½½
            time.sleep(3)
            
            # éªŒè¯å¯¼èˆªæˆåŠŸ
            try:
                new_url = self.driver.current_url
                if 'sora.chatgpt.com' in new_url.lower():
                    print('  âœ?å¯¼èˆªå®Œæˆ')
                else:
                    print(f'  âš ï¸  å½“å‰ URL: {new_url}')
                    print('  æç¤º: å¯èƒ½éœ€è¦æ‰‹åŠ¨ç™»å½•æˆ–å¤„ç†é¡µé¢')
            except:
                print('  âš ï¸  æ— æ³•è·å–å½“å‰ URL')
            
        except Exception as e:
            print(f'  âš ï¸  å¯¼èˆªæ—¶å‡ºç°é—®é¢? {e}')
            # ä¸æŠ›å‡ºå¼‚å¸¸ï¼Œç»§ç»­æ‰§è¡Œ
            print('  å°è¯•ç»§ç»­...')
    
    def _click_create_button(self):
        """ç‚¹å‡»åˆ›å»ºè§†é¢‘æŒ‰é’®"""
        try:
            print('  æŸ¥æ‰¾"åˆ›å»ºè§†é¢‘"æŒ‰é’®...')
            # æŸ¥æ‰¾"åˆ›å»ºè§†é¢‘"æŒ‰é’®
            buttons = self.driver.find_elements(By.TAG_NAME, 'button')
            for btn in buttons:
                try:
                    if 'åˆ›å»ºè§†é¢‘' in btn.text or 'Create' in btn.text:
                        print('  ç‚¹å‡»"åˆ›å»ºè§†é¢‘"æŒ‰é’®')
                        btn.click()
                        time.sleep(2)
                        return True
                except:
                    continue
            
            print('  æœªæ‰¾åˆ?åˆ›å»ºè§†é¢‘"æŒ‰é’®ï¼Œå¯èƒ½å·²åœ¨åˆ›å»ºé¡µé?)
            return True  # è¿”å› True ç»§ç»­æ‰§è¡Œ
        except Exception as e:
            print(f'  æŸ¥æ‰¾æŒ‰é’®æ—¶å‡ºé”? {e}')
            return True  # è¿”å› True ç»§ç»­æ‰§è¡Œ
    
    def _input_prompt(self, prompt):
        """è¾“å…¥æç¤ºè¯?- æ ¹æ®UAç±»å‹ä½¿ç”¨ä¸åŒç­–ç•¥"""
        print('  è¾“å…¥æç¤ºè¯?..')
        print(f'  æç¤ºè¯å†…å®? {prompt[:100]}{"..." if len(prompt) > 100 else ""}')
        print(f'  æç¤ºè¯é•¿åº? {len(prompt)} å­—ç¬¦')
        print(f'  å½“å‰UAç±»å‹: {"æ‰‹æœº" if self.is_mobile else "ç”µè„‘"}')
        
        if self.is_mobile:
            return self._input_prompt_mobile(prompt)
        else:
            return self._input_prompt_desktop(prompt)
    
    def _input_prompt_mobile(self, prompt):
        """æ‰‹æœºUAçš„è¾“å…¥ç­–ç•?- JavaScriptè¾“å…¥ + çœŸå®ç‚¹å‡»æ··åˆ"""
        print('  ä½¿ç”¨æ‰‹æœºUAè¾“å…¥ç­–ç•¥ï¼ˆJavaScript + çœŸå®ç‚¹å‡»æ··åˆï¼?..')
        print('  [DEBUG] å¼€å§‹æ‰§è¡Œæ‰‹æœºç«¯è¾“å…¥æµç¨‹')
        print('  [INFO] æ‰‹æœºç«¯send_keysä¼šå¡ä½ï¼Œä½¿ç”¨JavaScriptè¾“å…¥')
        
        try:
            from selenium.webdriver.common.keys import Keys
            
            # ç­‰å¾…é¡µé¢å®Œå…¨åŠ è½½
            print('  [DEBUG] ç­‰å¾…é¡µé¢åŠ è½½...')
            time.sleep(3)
            print('  [DEBUG] é¡µé¢åŠ è½½å®Œæˆ')
            
            # æŸ¥æ‰¾è¾“å…¥æ¡?- ä½¿ç”¨å¤šç§æ–¹æ³•
            print('  [DEBUG] æŸ¥æ‰¾è¾“å…¥æ¡?..')
            textarea = None
            
            # æ–¹æ³•1: é€šè¿‡placeholderåŒ…å«"Describe"
            try:
                print('  [DEBUG] æ–¹æ³•1: é€šè¿‡placeholderæŸ¥æ‰¾...')
                textarea = self.driver.find_element(By.CSS_SELECTOR, 'textarea[placeholder*="Describe"]')
                print('  âœ?æ‰¾åˆ°è¾“å…¥æ¡†ï¼ˆæ–¹æ³•1: placeholderåŒ…å«Describeï¼?)
            except Exception as e:
                print(f'  [DEBUG] æ–¹æ³•1å¤±è´¥: {e}')
            
            # æ–¹æ³•2: é€šè¿‡placeholderåŒ…å«"video"
            if not textarea:
                try:
                    print('  [DEBUG] æ–¹æ³•2: é€šè¿‡placeholderåŒ…å«videoæŸ¥æ‰¾...')
                    textarea = self.driver.find_element(By.CSS_SELECTOR, 'textarea[placeholder*="video"]')
                    print('  âœ?æ‰¾åˆ°è¾“å…¥æ¡†ï¼ˆæ–¹æ³•2: placeholderåŒ…å«videoï¼?)
                except Exception as e:
                    print(f'  [DEBUG] æ–¹æ³•2å¤±è´¥: {e}')
            
            # æ–¹æ³•3: é€šè¿‡classåŒ…å«rounded-mdçš„textarea
            if not textarea:
                try:
                    print('  [DEBUG] æ–¹æ³•3: é€šè¿‡classæŸ¥æ‰¾...')
                    textarea = self.driver.find_element(By.CSS_SELECTOR, 'textarea.rounded-md')
                    print('  âœ?æ‰¾åˆ°è¾“å…¥æ¡†ï¼ˆæ–¹æ³•3: classåŒ…å«rounded-mdï¼?)
                except Exception as e:
                    print(f'  [DEBUG] æ–¹æ³•3å¤±è´¥: {e}')
            
            # æ–¹æ³•4: æŸ¥æ‰¾æ‰€æœ‰textareaï¼Œä½¿ç”¨ç¬¬ä¸€ä¸ªå¯è§çš„
            if not textarea:
                try:
                    print('  [DEBUG] æ–¹æ³•4: æŸ¥æ‰¾æ‰€æœ‰textarea...')
                    textareas = self.driver.find_elements(By.TAG_NAME, 'textarea')
                    print(f'  [DEBUG] æ‰¾åˆ° {len(textareas)} ä¸?textarea å…ƒç´ ')
                    
                    for i, ta in enumerate(textareas):
                        try:
                            if ta.is_displayed():
                                textarea = ta
                                print(f'  âœ?æ‰¾åˆ°è¾“å…¥æ¡†ï¼ˆæ–¹æ³•4: ç¬¬{i+1}ä¸ªå¯è§textareaï¼?)
                                break
                        except:
                            continue
                except Exception as e:
                    print(f'  [DEBUG] æ–¹æ³•4å¤±è´¥: {e}')
            
            # å¦‚æœè¿˜æ˜¯æ²¡æ‰¾åˆ°ï¼ŒæŠ¥é”™
            if not textarea:
                print('  [ERROR] æ‰€æœ‰æ–¹æ³•éƒ½æœªæ‰¾åˆ°è¾“å…¥æ¡†')
                screenshot_path = f'error_screenshot_{int(time.time())}.png'
                self.driver.save_screenshot(screenshot_path)
                print(f'  å·²ä¿å­˜æˆªå›? {screenshot_path}')
                
                # æ‰“å°é¡µé¢æºç çš„ä¸€éƒ¨åˆ†ï¼Œå¸®åŠ©è°ƒè¯?
                try:
                    page_source = self.driver.page_source
                    if 'textarea' in page_source.lower():
                        print('  [DEBUG] é¡µé¢ä¸­å­˜åœ¨textareaå…ƒç´ ')
                        # æŸ¥æ‰¾textareaç›¸å…³çš„HTMLç‰‡æ®µ
                        import re
                        textareas_html = re.findall(r'<textarea[^>]*>', page_source, re.IGNORECASE)
                        for i, html in enumerate(textareas_html[:3]):  # åªæ˜¾ç¤ºå‰3ä¸?
                            print(f'  [DEBUG] Textarea {i+1}: {html[:200]}')
                    else:
                        print('  [DEBUG] é¡µé¢ä¸­ä¸å­˜åœ¨textareaå…ƒç´ ')
                except:
                    pass
                
                raise Exception('æœªæ‰¾åˆ°ä»»ä½•è¾“å…¥æ¡†')
            
            # æ£€æŸ¥è¾“å…¥æ¡†æ˜¯å¦å¯è§
            print('  [DEBUG] æ£€æŸ¥è¾“å…¥æ¡†å¯è§æ€?..')
            try:
                is_displayed = textarea.is_displayed()
                print(f'  [DEBUG] è¾“å…¥æ¡†å¯è§æ€? {is_displayed}')
                
                if not is_displayed:
                    print('  âš ï¸  è¾“å…¥æ¡†ä¸å¯è§ï¼Œå°è¯•æ»šåŠ¨åˆ°è§†å›¾')
                    self.driver.execute_script("arguments[0].scrollIntoView({behavior: 'auto', block: 'center'});", textarea)
                    time.sleep(1)
            except Exception as e:
                print(f'  [DEBUG] æ£€æŸ¥å¯è§æ€§å¤±è´? {e}')
            
            print('  âœ?æ‰¾åˆ°è¾“å…¥æ¡†ï¼Œå‡†å¤‡è¾“å…¥')
            
            # æ­¥éª¤1: çœŸå®ç‚¹å‡»è¾“å…¥æ¡†ï¼ˆé‡è¦ï¼šå…ˆå»ºç«‹çœŸå®äº¤äº’ï¼?
            print('  [DEBUG] çœŸå®ç‚¹å‡»è¾“å…¥æ¡?..')
            for i in range(3):
                try:
                    textarea.click()
                    time.sleep(0.5)
                    print(f'  âœ?ç¬¬{i+1}æ¬¡ç‚¹å‡»å®Œæˆ?)
                except Exception as e:
                    print(f'  [DEBUG] ç¬¬{i+1}æ¬¡ç‚¹å‡»å¤±è´? {e}')
            
            # æ­¥éª¤2: ä½¿ç”¨JavaScriptè¾“å…¥ï¼ˆé¿å…send_keyså¡ä½ï¼?
            print('  [DEBUG] ä½¿ç”¨JavaScriptè¾“å…¥æç¤ºè¯?..')
            print(f'  [DEBUG] æç¤ºè¯? {prompt[:50]}{"..." if len(prompt) > 50 else ""}')
            try:
                self.driver.execute_script("""
                    var textarea = arguments[0];
                    var text = arguments[1];
                    
                    // æ¸…ç©º
                    textarea.value = '';
                    
                    // èšç„¦
                    textarea.focus();
                    
                    // è®¾ç½®å€?
                    textarea.value = text;
                    
                    // è§¦å‘äº‹ä»¶ï¼ˆæ¨¡æ‹ŸçœŸå®è¾“å…¥ï¼‰
                    textarea.dispatchEvent(new Event('input', { bubbles: true }));
                    textarea.dispatchEvent(new Event('change', { bubbles: true }));
                    
                    // ä¿æŒç„¦ç‚¹
                    textarea.focus();
                """, textarea, prompt)
                time.sleep(0.5)
                print('  âœ?JavaScriptè¾“å…¥å®Œæˆ')
            except Exception as e:
                print(f'  [ERROR] JavaScriptè¾“å…¥å¤±è´¥: {e}')
                raise
            
            # éªŒè¯è¾“å…¥
            print('  [DEBUG] éªŒè¯è¾“å…¥ç»“æœ...')
            current_value = textarea.get_attribute('value') or ''
            print(f'  éªŒè¯è¾“å…¥ç»“æœ: å½“å‰é•¿åº¦ {len(current_value)}, ç›®æ ‡é•¿åº¦ {len(prompt)}')
            
            if len(current_value) == 0:
                print('  âš ï¸  è¾“å…¥éªŒè¯å¤±è´¥ï¼Œè¾“å…¥æ¡†ä»ä¸ºç©?)
                screenshot_path = f'error_screenshot_{int(time.time())}.png'
                self.driver.save_screenshot(screenshot_path)
                print(f'  å·²ä¿å­˜æˆªå›? {screenshot_path}')
                raise Exception('è¾“å…¥åéªŒè¯å¤±è´¥ï¼Œè¾“å…¥æ¡†ä»ä¸ºç©º')
            
            print(f'  âœ?è¾“å…¥éªŒè¯æˆåŠŸï¼ˆå½“å‰é•¿åº? {len(current_value)}ï¼?)
            
            # æ­¥éª¤3: å…³é”® - å¤šæ¬¡çœŸå®ç‚¹å‡»è¾“å…¥æ¡†ï¼ˆæ¿€æ´»å‘é€æŒ‰é’?+ æ©ç›–è„šæœ¬ç‰¹å¾ï¼?
            print('  [DEBUG] å¤šæ¬¡çœŸå®ç‚¹å‡»è¾“å…¥æ¡†ï¼ˆæ¿€æ´»å‘é€æŒ‰é’®ï¼‰...')
            for i in range(8):  # å¢åŠ åˆ?æ¬¡ï¼Œç¡®ä¿æŒ‰é’®æ¿€æ´?
                try:
                    textarea.click()
                    time.sleep(0.5)  # å¢åŠ é—´éš”ï¼Œæ›´åƒçœŸäº?
                    print(f'  âœ?ç¬¬{i+1}æ¬¡ç‚¹å‡»å®Œæˆ?)
                except Exception as e:
                    print(f'  [DEBUG] ç¬¬{i+1}æ¬¡ç‚¹å‡»å¤±è´? {e}')
            
            # æ­¥éª¤4: ç­‰å¾…å‘é€æŒ‰é’®æ¿€æ´?
            print('  [DEBUG] ç­‰å¾…å‘é€æŒ‰é’®æ¿€æ´?..')
            time.sleep(2)
            
            # æ­¥éª¤5: æŸ¥æ‰¾å¹¶ç‚¹å‡»å‘é€æŒ‰é’?
            print('  [DEBUG] æŸ¥æ‰¾å‘é€æŒ‰é’?..')
            send_success = False
            
            try:
                buttons = self.driver.find_elements(By.TAG_NAME, 'button')
                print(f'  æ‰¾åˆ° {len(buttons)} ä¸ªæŒ‰é’®å…ƒç´?)
                
                for btn in buttons:
                    try:
                        disabled = btn.get_attribute('disabled')
                        aria_disabled = btn.get_attribute('aria-disabled')
                        
                        if not disabled and aria_disabled != 'true':
                            if btn.is_displayed():
                                class_name = btn.get_attribute('class') or ''
                                
                                if 'rounded-full' in class_name:
                                    print(f'  [DEBUG] æ‰¾åˆ°å‘é€æŒ‰é’®ï¼Œç‚¹å‡»...')
                                    btn.click()
                                    time.sleep(1)
                                    print('  âœ?å‘é€æŒ‰é’®å·²ç‚¹å‡»')
                                    send_success = True
                                    break
                    except:
                        continue
                        
            except Exception as e:
                print(f'  [DEBUG] æŸ¥æ‰¾æŒ‰é’®å¤±è´¥: {e}')
            
            # å¦‚æœæ²¡æ‰¾åˆ°æŒ‰é’®ï¼Œä½¿ç”¨JavaScriptè§¦å‘å›è½¦
            if not send_success:
                print('  [DEBUG] æœªæ‰¾åˆ°å‘é€æŒ‰é’®ï¼Œä½¿ç”¨JavaScriptè§¦å‘å›è½¦...')
                try:
                    self.driver.execute_script("""
                        var textarea = arguments[0];
                        textarea.focus();
                        var event = new KeyboardEvent('keydown', {
                            key: 'Enter',
                            code: 'Enter',
                            keyCode: 13,
                            which: 13,
                            bubbles: true,
                            cancelable: true
                        });
                        textarea.dispatchEvent(event);
                    """, textarea)
                    time.sleep(1)
                    print('  âœ?JavaScriptè§¦å‘å›è½¦å®Œæˆ')
                    send_success = True
                except Exception as e:
                    print(f'  [DEBUG] JavaScriptå›è½¦å¤±è´¥: {e}')
            
            if not send_success:
                print('  [WARNING] æ— æ³•ç¡®è®¤æ¶ˆæ¯æ˜¯å¦å‘é€?)
            
            print('  [DEBUG] æ‰‹æœºç«¯è¾“å…¥æµç¨‹å®Œæˆ?)
            return True
            
        except Exception as e:
            print(f'  [ERROR] æ‰‹æœºUAè¾“å…¥å¤±è´¥: {e}')
            print(f'  [ERROR] é”™è¯¯ç±»å‹: {type(e).__name__}')
            import traceback
            print('  [ERROR] å®Œæ•´å †æ ˆ:')
            traceback.print_exc()
            try:
                screenshot_path = f'error_screenshot_{int(time.time())}.png'
                self.driver.save_screenshot(screenshot_path)
                print(f'  å·²ä¿å­˜é”™è¯¯æˆªå›? {screenshot_path}')
            except Exception as e2:
                print(f'  [ERROR] ä¿å­˜æˆªå›¾å¤±è´¥: {e2}')
            raise
                
    def _input_prompt_desktop(self, prompt):
        """ç”µè„‘UAçš„è¾“å…¥ç­–ç•?- çœŸå®ç‚¹å‡»å’Œé”®ç›˜è¾“å…?""
        print('  ä½¿ç”¨ç”µè„‘UAè¾“å…¥ç­–ç•¥...')
        
        try:
            # ç­‰å¾…é¡µé¢å®Œå…¨åŠ è½½
            time.sleep(2)
            
            # æ–¹æ³•1: é€šè¿‡ placeholder ç²¾ç¡®æŸ¥æ‰¾è¾“å…¥æ¡?
            print('  å°è¯•é€šè¿‡ placeholder æŸ¥æ‰¾è¾“å…¥æ¡?..')
            try:
                textarea = self.driver.find_element(By.CSS_SELECTOR, 'textarea[placeholder*="Describe your video"]')
                print('  âœ?æ‰¾åˆ°è¾“å…¥æ¡†ï¼ˆé€šè¿‡ placeholderï¼?)
            except:
                print('  æœªæ‰¾åˆ°å¸¦ placeholder çš„è¾“å…¥æ¡†ï¼Œå°è¯•å…¶ä»–æ–¹æ³?..')
                # æ–¹æ³•2: æŸ¥æ‰¾æ‰€æœ?textarea
                textareas = self.driver.find_elements(By.TAG_NAME, 'textarea')
                print(f'  æ‰¾åˆ° {len(textareas)} ä¸?textarea å…ƒç´ ')
                
                if not textareas:
                    # ä¿å­˜æˆªå›¾å¸®åŠ©è°ƒè¯•
                    screenshot_path = f'error_screenshot_{int(time.time())}.png'
                    self.driver.save_screenshot(screenshot_path)
                    print(f'  å·²ä¿å­˜æˆªå›? {screenshot_path}')
                    raise Exception('æœªæ‰¾åˆ°ä»»ä½•è¾“å…¥æ¡†')
                
                textarea = textareas[0]  # ä½¿ç”¨ç¬¬ä¸€ä¸?
                print('  ä½¿ç”¨ç¬¬ä¸€ä¸?textarea å…ƒç´ ')
            
            # æ£€æŸ¥å…ƒç´ æ˜¯å¦å¯è§?
            if not textarea.is_displayed():
                print('  âš ï¸  è¾“å…¥æ¡†ä¸å¯è§')
                screenshot_path = f'error_screenshot_{int(time.time())}.png'
                self.driver.save_screenshot(screenshot_path)
                print(f'  å·²ä¿å­˜æˆªå›? {screenshot_path}')
                raise Exception('è¾“å…¥æ¡†ä¸å¯è§')
            
            print('  æ‰¾åˆ°è¾“å…¥æ¡†ï¼Œå‡†å¤‡è¾“å…¥')
            
            # æ­¥éª¤1: å…ˆæ¸…ç©ºè¾“å…¥æ¡†
            print('  æ¸…ç©ºè¾“å…¥æ¡?..')
            try:
                textarea.clear()
                time.sleep(0.3)
                print('  âœ?è¾“å…¥æ¡†å·²æ¸…ç©º')
            except Exception as e:
                print(f'  æ¸…ç©ºè¾“å…¥æ¡†å¤±è´? {e}ï¼Œç»§ç»­æ‰§è¡?..')
            
            # æ­¥éª¤2: çœŸå®ç‚¹å‡»è¾“å…¥æ¡†ï¼ˆæ¿€æ´»è¾“å…¥æ¡†ï¼?
            print('  çœŸå®ç‚¹å‡»è¾“å…¥æ¡†ï¼ˆæ¿€æ´»ï¼‰...')
            try:
                textarea.click()
                time.sleep(0.5)
                print('  âœ?è¾“å…¥æ¡†å·²æ¿€æ´?)
            except Exception as e:
                print(f'  ç‚¹å‡»è¾“å…¥æ¡†å¤±è´? {e}')
                raise
            
            # æ­¥éª¤3: ä½¿ç”¨ send_keys çœŸå®è¾“å…¥ï¼ˆæ¨¡æ‹Ÿé”®ç›˜è¾“å…¥ï¼‰
            print('  ä½¿ç”¨ send_keys çœŸå®è¾“å…¥...')
            from selenium.webdriver.common.keys import Keys
            try:
                textarea.send_keys(prompt)
                time.sleep(0.5)
                print('  âœ?æç¤ºè¯å·²è¾“å…¥')
            except Exception as e:
                print(f'  è¾“å…¥å¤±è´¥: {e}')
                raise
            
            # éªŒè¯è¾“å…¥æ˜¯å¦æˆåŠŸ
            current_value = textarea.get_attribute('value') or ''
            print(f'  éªŒè¯è¾“å…¥ç»“æœ: å½“å‰é•¿åº¦ {len(current_value)}, ç›®æ ‡é•¿åº¦ {len(prompt)}')
            
            if len(current_value) == 0:
                print('  âš ï¸  è¾“å…¥éªŒè¯å¤±è´¥ï¼Œè¾“å…¥æ¡†ä»ä¸ºç©?)
                screenshot_path = f'error_screenshot_{int(time.time())}.png'
                self.driver.save_screenshot(screenshot_path)
                print(f'  å·²ä¿å­˜æˆªå›? {screenshot_path}')
                raise Exception('è¾“å…¥åéªŒè¯å¤±è´¥ï¼Œè¾“å…¥æ¡†ä»ä¸ºç©º')
            
            print(f'  âœ?è¾“å…¥éªŒè¯æˆåŠŸï¼ˆå½“å‰é•¿åº? {len(current_value)}ï¼?)
            
            # æ­¥éª¤4: å†æ¬¡ç‚¹å‡»è¾“å…¥æ¡†ï¼ˆç¡®ä¿ç„¦ç‚¹åœ¨è¾“å…¥æ¡†ä¸Šï¼‰
            print('  å†æ¬¡ç‚¹å‡»è¾“å…¥æ¡†ï¼ˆç¡®ä¿ç„¦ç‚¹ï¼?..')
            try:
                textarea.click()
                time.sleep(0.3)
                print('  âœ?ç„¦ç‚¹å·²ç¡®è®?)
            except Exception as e:
                print(f'  å†æ¬¡ç‚¹å‡»å¤±è´¥: {e}ï¼Œç»§ç»­æ‰§è¡?..')
            
            # æ­¥éª¤5: æŒ‰å›è½¦é”®å‘é€?
            print('  æŒ‰å›è½¦é”®å‘é€?..')
            try:
                textarea.send_keys(Keys.RETURN)
                time.sleep(1)
                print('  âœ?å·²æŒ‰å›è½¦é”®å‘é€?)
            except Exception as e:
                print(f'  æŒ‰å›è½¦é”®å¤±è´¥: {e}')
                raise
            
            return True
            
        except Exception as e:
            print(f'  ç”µè„‘UAè¾“å…¥å¤±è´¥: {e}')
            print(f'  é”™è¯¯ç±»å‹: {type(e).__name__}')
            import traceback
            traceback.print_exc()
            # å°è¯•æˆªå›¾ä¿å­˜é”™è¯¯çŠ¶æ€?
            try:
                screenshot_path = f'error_screenshot_{int(time.time())}.png'
                self.driver.save_screenshot(screenshot_path)
                print(f'  å·²ä¿å­˜é”™è¯¯æˆªå›? {screenshot_path}')
            except:
                pass
            raise
    
    def _click_send_button(self):
        """ç‚¹å‡»å‘é€æŒ‰é’?""
        print('  æŸ¥æ‰¾å‘é€æŒ‰é’?..')
        
        try:
            # æ–¹æ³•1: æŸ¥æ‰¾å¸?sr-only çš„æŒ‰é’?
            buttons = self.driver.find_elements(By.TAG_NAME, 'button')
            print(f'  æ‰¾åˆ° {len(buttons)} ä¸ªæŒ‰é’®å…ƒç´?)
            
            for btn in buttons:
                try:
                    sr_only_elements = btn.find_elements(By.CLASS_NAME, 'sr-only')
                    for sr_only in sr_only_elements:
                        if 'åˆ›å»ºè§†é¢‘' in sr_only.text or 'Create' in sr_only.text:
                            disabled = btn.get_attribute('data-disabled')
                            aria_disabled = btn.get_attribute('aria-disabled')
                            if disabled != 'true' and aria_disabled != 'true':
                                print('  æ‰¾åˆ°å‘é€æŒ‰é’®ï¼ˆsr-onlyæ–¹æ³•ï¼‰ï¼Œå°è¯•ç‚¹å‡»...')
                                try:
                                    # ä½¿ç”¨ JavaScript ç‚¹å‡»ï¼Œæ›´å¯é 
                                    self.driver.execute_script("arguments[0].click();", btn)
                                    print('  âœ?å‘é€æŒ‰é’®å·²ç‚¹å‡»ï¼ˆJavaScriptï¼?)
                                    time.sleep(1)
                                    return True
                                except:
                                    # å¦‚æœ JS ç‚¹å‡»å¤±è´¥ï¼Œå°è¯•å¸¸è§„ç‚¹å‡?
                                    btn.click()
                                    print('  âœ?å‘é€æŒ‰é’®å·²ç‚¹å‡»ï¼ˆå¸¸è§„æ–¹æ³•ï¼‰')
                                    time.sleep(1)
                                    return True
                except:
                    continue
            
            # æ–¹æ³•2: æŸ¥æ‰¾åœ†å½¢æŒ‰é’®
            print('  å°è¯•æŸ¥æ‰¾åœ†å½¢æŒ‰é’®...')
            for btn in buttons:
                try:
                    class_name = btn.get_attribute('class') or ''
                    if 'rounded-full' in class_name:
                        disabled = btn.get_attribute('data-disabled')
                        aria_disabled = btn.get_attribute('aria-disabled')
                        is_disabled = btn.get_attribute('disabled')
                        
                        if disabled != 'true' and aria_disabled != 'true' and not is_disabled:
                            print(f'  æ‰¾åˆ°åœ†å½¢æŒ‰é’®ï¼Œclass: {class_name[:50]}...')
                            try:
                                # ä½¿ç”¨ JavaScript ç‚¹å‡»
                                self.driver.execute_script("arguments[0].click();", btn)
                                print('  âœ?å‘é€æŒ‰é’®å·²ç‚¹å‡»ï¼ˆJavaScriptï¼?)
                                time.sleep(1)
                                return True
                            except:
                                btn.click()
                                print('  âœ?å‘é€æŒ‰é’®å·²ç‚¹å‡»ï¼ˆå¸¸è§„æ–¹æ³•ï¼‰')
                                time.sleep(1)
                                return True
                except:
                    continue
            
            # æ–¹æ³•3: æ¨¡æ‹ŸæŒ‰å›è½¦é”®
            print('  æœªæ‰¾åˆ°å¯ç”¨æŒ‰é’®ï¼Œå°è¯•æŒ‰å›è½¦é”®...')
            from selenium.webdriver.common.keys import Keys
            textareas = self.driver.find_elements(By.TAG_NAME, 'textarea')
            if textareas:
                print('  åœ¨è¾“å…¥æ¡†ä¸­æŒ‰å›è½¦é”?..')
                textareas[0].send_keys(Keys.RETURN)
                print('  âœ?å·²æŒ‰å›è½¦é”®å‘é€?)
                time.sleep(1)
                return True
            
            # æ–¹æ³•4: ä½¿ç”¨ JavaScript è§¦å‘è¡¨å•æäº¤
            print('  å°è¯•ä½¿ç”¨ JavaScript è§¦å‘æäº¤...')
            self.driver.execute_script("""
                // æŸ¥æ‰¾è¾“å…¥æ¡?
                var textarea = document.querySelector('textarea');
                if (textarea) {
                    // è§¦å‘ Enter é”®äº‹ä»?
                    var event = new KeyboardEvent('keydown', {
                        key: 'Enter',
                        code: 'Enter',
                        keyCode: 13,
                        which: 13,
                        bubbles: true
                    });
                    textarea.dispatchEvent(event);
                }
            """)
            print('  âœ?å·²è§¦å?Enter é”®äº‹ä»?)
            time.sleep(1)
            return True
            
        except Exception as e:
            print(f'  ç‚¹å‡»å‘é€æŒ‰é’®å¤±è´? {e}')
            import traceback
            traceback.print_exc()
            raise
    
    def _wait_for_video(self, timeout=600):
        """ç­‰å¾…è§†é¢‘ç”Ÿæˆå®Œæˆ - é€šè¿‡æ£€æµ‹è¾“å…¥æ¡†æ˜¯å¦æ¸…ç©ºæ¥åˆ¤æ–?""
        print('  ç­‰å¾…è§†é¢‘ç”Ÿæˆ...')
        
        # è®°å½•å¼€å§‹æ—¶å·²å­˜åœ¨çš„è§†é¢‘ URLï¼Œé¿å…æ£€æµ‹åˆ°æ—§è§†é¢?
        existing_video_urls = set()
        try:
            existing_videos = self.driver.find_elements(By.TAG_NAME, 'video')
            for video in existing_videos:
                src = video.get_attribute('src')
                if src:
                    existing_video_urls.add(src)
            if existing_video_urls:
                print(f'  æ£€æµ‹åˆ° {len(existing_video_urls)} ä¸ªå·²å­˜åœ¨çš„è§†é¢‘ï¼Œå°†å¿½ç•?)
        except:
            pass
        
        # è®°å½•å‘é€çš„æç¤ºè¯ï¼ˆç”¨äºæ£€æµ‹è¾“å…¥æ¡†æ˜¯å¦æ¸…ç©ºï¼?
        sent_prompt = None
        try:
            textareas = self.driver.find_elements(By.TAG_NAME, 'textarea')
            if textareas:
                sent_prompt = textareas[0].get_attribute('value') or textareas[0].text
                print(f'  å·²è®°å½•æç¤ºè¯é•¿åº¦: {len(sent_prompt) if sent_prompt else 0}')
        except:
            pass
        
        start_time = time.time()
        last_status = None
        generation_completed = False
        
        while time.time() - start_time < timeout:
            try:
                elapsed = int(time.time() - start_time)
                
                # æ–¹æ³•1: æ£€æµ‹è¾“å…¥æ¡†æ˜¯å¦å·²æ¸…ç©ºï¼ˆæœ€å¯é çš„æ–¹æ³•ï¼‰
                if not generation_completed:
                    try:
                        textareas = self.driver.find_elements(By.TAG_NAME, 'textarea')
                        if textareas:
                            current_value = textareas[0].get_attribute('value') or textareas[0].text or ''
                            current_value = current_value.strip()
                            
                            # å¦‚æœè¾“å…¥æ¡†å·²æ¸…ç©ºæˆ–å†…å®¹ä¸å‘é€çš„æç¤ºè¯ä¸åŒï¼Œè¯´æ˜å¯ä»¥è¾“å…¥æ–°å†…å®¹äº†
                            if sent_prompt and len(current_value) == 0:
                                print('  âœ?è¾“å…¥æ¡†å·²æ¸…ç©ºï¼Œè§†é¢‘ç”Ÿæˆå®Œæˆ?)
                                generation_completed = True
                                time.sleep(2)  # ç­‰å¾…2ç§’è®©è§†é¢‘å®Œå…¨åŠ è½½
                            elif elapsed > 10 and len(current_value) == 0:
                                # å¦‚æœ10ç§’åè¾“å…¥æ¡†è¿˜æ˜¯ç©ºçš„ï¼Œä¹Ÿè®¤ä¸ºå®Œæˆäº†
                                print('  âœ?è¾“å…¥æ¡†ä¸ºç©ºï¼Œè§†é¢‘ç”Ÿæˆå®Œæˆ')
                                generation_completed = True
                                time.sleep(2)
                    except Exception as e:
                        if elapsed % 30 == 0:
                            print(f'  æ£€æŸ¥è¾“å…¥æ¡†æ—¶å‡ºé”? {e}')
                
                # æ–¹æ³•2: æ£€æµ‹ç”ŸæˆçŠ¶æ€æ–‡æœ?
                try:
                    status_elements = self.driver.find_elements(By.XPATH, 
                        "//*[contains(text(), 'ç”Ÿæˆ') or contains(text(), 'Generating') or contains(text(), 'Processing') or contains(text(), '%')]")
                    
                    current_status = None
                    for elem in status_elements:
                        try:
                            if elem.is_displayed():
                                status_text = elem.text.strip()
                                if status_text and len(status_text) < 100:  # é¿å…è·å–åˆ°é•¿æ–‡æœ¬
                                    current_status = status_text
                                    if status_text != last_status:
                                        last_status = status_text
                                        print(f'  â?çŠ¶æ€? {status_text}')
                                    break
                        except:
                            pass
                    
                    # å¦‚æœæ²¡æœ‰ç”ŸæˆçŠ¶æ€æ–‡æœ¬äº†ï¼Œå¯èƒ½å·²å®Œæˆ
                    if not current_status and elapsed > 10:
                        if not generation_completed:
                            print('  âœ?æœªæ£€æµ‹åˆ°ç”ŸæˆçŠ¶æ€ï¼Œå¯èƒ½å·²å®Œæˆ?)
                            generation_completed = True
                            time.sleep(2)
                except:
                    pass
                
                # æ–¹æ³•3: æ£€æŸ¥é”™è¯?
                try:
                    error_keywords = ['é”™è¯¯', 'error', 'Error', 'å¤±è´¥', 'failed', 'Failed']
                    for keyword in error_keywords:
                        error_elements = self.driver.find_elements(By.XPATH, f"//*[contains(text(), '{keyword}')]")
                        for elem in error_elements:
                            if elem.is_displayed():
                                error_text = elem.text.strip()
                                if error_text and len(error_text) > 3:
                                    print(f'  âœ?æ£€æµ‹åˆ°é”™è¯¯: {error_text}')
                                    return {'success': False, 'error': error_text, 'duration': elapsed}
                except:
                    pass
                
                # æ–¹æ³•4: éªŒè¯è§†é¢‘å·²ç”Ÿæˆ?
                if generation_completed:
                    try:
                        videos = self.driver.find_elements(By.TAG_NAME, 'video')
                        for video in videos:
                            src = video.get_attribute('src')
                            # å¿…é¡»æ˜¯æ–°è§†é¢‘ï¼ˆä¸åœ¨å·²å­˜åœ¨åˆ—è¡¨ä¸­ï¼‰
                            if src and src not in existing_video_urls:
                                # æ£€æŸ¥æ˜¯å¦æ˜¯æœ‰æ•ˆçš?HTTP URLï¼ˆä¸æ˜?blobï¼?
                                if src.startswith('http') and 'blob:' not in src:
                                    try:
                                        # æ£€æŸ¥è§†é¢‘æ˜¯å¦å¯ä»¥æ’­æ”?
                                        duration = self.driver.execute_script("return arguments[0].duration;", video)
                                        readyState = self.driver.execute_script("return arguments[0].readyState;", video)
                                        
                                        # readyState >= 2 è¡¨ç¤ºè§†é¢‘å·²åŠ è½½å…ƒæ•°æ®
                                        # duration > 0 è¡¨ç¤ºè§†é¢‘æœ‰æœ‰æ•ˆæ—¶é•?
                                        if duration and duration > 0 and readyState >= 2:
                                            elapsed_time = time.time() - start_time
                                            print(f'  âœ?è§†é¢‘ç”Ÿæˆå®Œæˆå¹¶éªŒè¯æˆåŠŸï¼')
                                            print(f'  æ€»è€—æ—¶: {elapsed_time:.1f}ç§?)
                                            print(f'  è§†é¢‘æ—¶é•¿: {duration:.1f}ç§?)
                                            print(f'  è§†é¢‘URL: {src[:100]}...')
                                            return {
                                                'success': True, 
                                                'video_url': src, 
                                                'duration': elapsed_time, 
                                                'video_duration': duration
                                            }
                                        else:
                                            # è§†é¢‘è¿˜åœ¨åŠ è½½ï¼Œç»§ç»­ç­‰å¾?
                                            if elapsed % 10 == 0:
                                                print(f'  â?è§†é¢‘åŠ è½½ä¸?.. (duration={duration}, readyState={readyState})')
                                            time.sleep(2)
                                            continue
                                    except Exception as e:
                                        if elapsed % 30 == 0:
                                            print(f'  æ£€æŸ¥è§†é¢‘çŠ¶æ€å¤±è´? {e}')
                    except Exception as e:
                        if elapsed % 30 == 0:
                            print(f'  æŸ¥æ‰¾è§†é¢‘å…ƒç´ å¤±è´¥: {e}')
                
                # æ¯?ç§’æ£€æŸ¥ä¸€æ¬?
                time.sleep(5)
                
                # æ˜¾ç¤ºç­‰å¾…è¿›åº¦ï¼ˆæ¯30ç§’ï¼‰
                if elapsed % 30 == 0 and elapsed > 0:
                    status = "éªŒè¯ä¸? if generation_completed else "ç”Ÿæˆä¸?
                    print(f'  â?{status}... ({elapsed}ç§?/ {timeout}ç§?')
            
            except Exception as e:
                print(f'  æ£€æŸ¥æ—¶å‡ºé”™: {e}')
                import traceback
                traceback.print_exc()
                time.sleep(5)
        
        return {'success': False, 'error': f'è¶…æ—¶ ({timeout}ç§?', 'duration': timeout}
    
    def _download_video(self, video_url):
        """ä¸‹è½½è§†é¢‘"""
        print('  ä¸‹è½½è§†é¢‘...')
        
        try:
            # ä½¿ç”¨ JavaScript è§¦å‘ä¸‹è½½
            script = f"""
            var a = document.createElement('a');
            a.href = '{video_url}';
            a.download = 'sora-{int(time.time())}.mp4';
            a.click();
            """
            self.driver.execute_script(script)
            print('  âœ?ä¸‹è½½å·²è§¦å?)
            return True
        except Exception as e:
            print(f'  ä¸‹è½½å¤±è´¥: {e}')
            return False
    
    def generate_video(self, prompt, image=None, auto_download=True):
        """
        ç”Ÿæˆè§†é¢‘
        
        Args:
            prompt: è§†é¢‘æç¤ºè¯?
            image: å‚è€ƒå›¾ç‰?URLï¼ˆå¯é€‰ï¼‰
            auto_download: æ˜¯å¦è‡ªåŠ¨ä¸‹è½½
        
        Returns:
            dict: ç”Ÿæˆç»“æœ
        """
        try:
            # 1. æ‰“å¼€æµè§ˆå™?
            if self.driver is None:
                self._open_browser()
            
            # 2. å¯¼èˆªåˆ?Sora
            self._navigate_to_sora()
            
            # 3. ç‚¹å‡»åˆ›å»ºæŒ‰é’®
            self._click_create_button()
            
            # 4. è¾“å…¥æç¤ºè¯å¹¶å‘é€ï¼ˆå·²åŒ…å«ç‚¹å‡»å’Œå›è½¦å‘é€ï¼‰
            self._input_prompt(prompt)
            
            # 5. ç­‰å¾…è§†é¢‘ç”Ÿæˆ
            result = self._wait_for_video()
            
            # 7. ä¸‹è½½è§†é¢‘
            if result['success'] and auto_download:
                self._download_video(result['video_url'])
            
            return result
        
        except Exception as e:
            return {'success': False, 'error': str(e)}
    
    def cleanup(self):
        """æ¸…ç†èµ„æº - å¸¦è¶…æ—¶å’Œå¼ºåˆ¶å…³é—­"""
        print(f'  æ¸…ç†çª—å£ {self.profile_id} çš„èµ„æº?..')
        
        # å…ˆå°è¯•å…³é—­driver
        if self.driver:
            try:
                print(f'  å°è¯•å…³é—­ driver...')
                # è®¾ç½®ä¸€ä¸ªçŸ­è¶…æ—¶ï¼Œé¿å…å¡ä½?
                import signal
                
                def timeout_handler(signum, frame):
                    raise TimeoutError("driver.quit() è¶…æ—¶")
                
                # Windowsä¸æ”¯æŒsignal.alarmï¼Œä½¿ç”¨threading.Timerä»£æ›¿
                import threading
                
                quit_success = [False]
                
                def quit_driver():
                    try:
                        self.driver.quit()
                        quit_success[0] = True
                    except:
                        pass
                
                # å¯åŠ¨ä¸€ä¸ªçº¿ç¨‹æ¥å…³é—­driverï¼Œæœ€å¤šç­‰å¾?ç§?
                quit_thread = threading.Thread(target=quit_driver)
                quit_thread.daemon = True
                quit_thread.start()
                quit_thread.join(timeout=3)
                
                if quit_success[0]:
                    print(f'  âœ?driver å·²å…³é—?)
                else:
                    print(f'  âš ï¸  driver.quit() è¶…æ—¶ï¼Œå¼ºåˆ¶ç»§ç»?)
                    
            except Exception as e:
                print(f'  âš ï¸  å…³é—­ driver å¤±è´¥: {e}')
        
        # é€šè¿‡APIå…³é—­çª—å£
        if self.profile_id:
            try:
                print(f'  é€šè¿‡ API å…³é—­çª—å£ {self.profile_id}...')
                result = self.client.close_profile(self.profile_id)
                if result:
                    print(f'  âœ?çª—å£ {self.profile_id} å·²é€šè¿‡APIå…³é—­')
                else:
                    print(f'  âš ï¸  APIå…³é—­å¤±è´¥: {self.client.message}')
            except Exception as e:
                print(f'  âš ï¸  APIå…³é—­çª—å£å¤±è´¥: {e}')
        
        print(f'  çª—å£ {self.profile_id} æ¸…ç†å®Œæˆ')
